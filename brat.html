<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BRAT — EW</title>
<link rel="stylesheet" href="style.css" />

<style>
/* =====================================================
   BRAT — CLEAN DARK LAYOUT (FULL WIDTH SYNCHRONIZED)
   FIXED SMOOTH TOOLBAR + MOBILE HORIZONTAL SCROLL
   & RICH-EDITOR COMPAT (desktop + mobile)
===================================================== */

/* Variables */
:root {
  --gutter: 40px;
  --header-h: 170px;
  --footer-h: 40px;
  --toolbar-gap: 10px;
  /* Glassmorphism Effect */
  --glass-bg-primary: rgba(255, 255, 255, 0.051); 
  --glass-bg: rgba(255, 255, 255, 0.033); 
  --glass-border: rgba(255, 255, 255, 0.115);
  --glass-shadow-primary: rgba(0, 0, 0, 0.3); 
  --text-color-light: #f1f1f1;
}

/* Body */
body.page-brat {
  position: relative; /* reference untuk ::before */
  overflow-x: hidden;
  min-height: 100vh;
  color: #d6d6d6;
  font-family: "Doto", sans-serif;
  background: none; /* hapus background global */
}

body.page-brat::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-image: url('asset/bratdesktop.png');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  z-index: -1;
}

/* Background mobile */
@media (max-width: 720px) {
  body.page-brat::before {
    background-image: url('asset/bratmobile.png');
    background-size: cover;
    background-position: center top;
    z-index: -1;
  }
}

/* Full width content (shifted down to leave space for toolbar) */
.content-wrap {
  position: absolute;
  top: var(--header-h);
  left: 220px; 
  right: 220px; 
  bottom: 40px;
  transition: left .28s ease;
  overflow: hidden;
  padding: 18px;
}

/* Editor container */
.brat-editor-card {
  width: 100%;
  height: 100%;
  background: var(--glass-bg-primary);
  backdrop-filter: blur(20px) saturate(150%);
  -webkit-backdrop-filter: blur(20px) saturate(150%);
  border-radius: 18px;
  border: 1px solid var(--glass-border);
  padding: 26px;
  overflow-y: auto;
  box-shadow: 0 8px 32px 0 var(--glass-shadow-primary), inset 0 0 0 1px rgba(255,255,255,0.1);
  color: #dcdcdc;
  line-height: 1.6;
  
  /* Rich edit compatibility */
  -webkit-user-modify: read-only; /* Default: read-only untuk viewer */
  -webkit-user-select: text;
  user-select: text;
  outline: none;
  -webkit-tap-highlight-color: transparent;
}

/* Style untuk mode edit (admin) */
.brat-editor-card.editable {
  -webkit-user-modify: read-write;
  cursor: text;
}

/* Style untuk mode view (non-admin) */
.brat-editor-card.view-only {
  -webkit-user-modify: read-only;
  cursor: default;
}

/* Make article focusable for editor.focus() */
.brat-editor-card:focus { 
  box-shadow: 0 0 0 2px rgba(220, 234, 241, 0.429) inset; 
}

/* =====================================================
   FIXED FLOATING TOOLBAR (SMOOTH)
===================================================== */
.editor-toolbar-fixed {
  position: fixed;
  top: calc(var(--header-h) + -30px); /* diperbaiki: 10px below header */
  left: 50%;
  transform: translateX(-50%);
  width: fit-content;
  background: rgba(20,20,20,0.92);
  border: 1px solid rgba(255,255,255,0.10);
  padding: 10px 14px;
  border-radius: 12px;
  display: none; /* Hidden by default, only show when admin */
  gap: var(--toolbar-gap);
  align-items: center;
  z-index: 9999;
  backdrop-filter: blur(6px);
  transition: box-shadow .18s ease, transform .18s ease, opacity .18s ease;
}

/* Shadow when scrolling */
.editor-toolbar-fixed.scrolled {
  box-shadow: 0 8px 32px rgba(0,0,0,0.6);
  transform: translate(-50%, 4px);
}

/* Buttons / selects */
.editor-toolbar-fixed select,
.editor-toolbar-fixed button,
.editor-toolbar-fixed input[type="color"] {
  background: rgba(255,255,255,0.04);
  color: #e8e8e8;
  border: 1px solid rgba(255,255,255,0.08);
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  white-space: nowrap;
}

.editor-toolbar-fixed button:hover {
  background: rgba(255,255,255,0.10);
}

/* Desktop layout remains centered */
@media (min-width: 721px) {
  .editor-toolbar-fixed { 
    width: fit-content; 
    left: 50%; 
    transform: translateX(-50%); 
    border-radius: 12px; 
  }
}

/* =====================================================
   MOBILE: toolbar becomes horizontal scrollable bar
===================================================== */
@media (max-width:720px) {
  .content-wrap {
    left: 30px; 
    right: 30px;
    top: calc(var(--header-h) + 60px);
    bottom: 65px;
    padding: 10px; /* Padding sedikit disesuaikan untuk mobile */
  }

  .editor-toolbar-fixed {
    position: fixed;
    top: calc(var(--header-h) + 15px); 
    left: 0;
    right: 0;
    transform: none;
    width: 100%;
    padding: 8px 12px;
    border-radius: 0;
    background: rgba(18,18,18,0.92);
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
  }

  .editor-toolbar-fixed::-webkit-scrollbar { height: 6px; }
  .editor-toolbar-fixed::-webkit-scrollbar-thumb { 
    background: rgba(255,255,255,0.12); 
    border-radius: 6px; 
  }

  .editor-toolbar-fixed select,
  .editor-toolbar-fixed button,
  .editor-toolbar-fixed input[type="color"] {
    display: inline-block;
    margin-right: 8px;
  }
}

/* Small adjustments */
.editor-toolbar-fixed select { min-width: 88px; }
.editor-toolbar-fixed input[type="color"] { padding: 6px; width: 40px; }

/* Style untuk cursor di mode berbeda */
.brat-editor-card.view-only * {
  cursor: default !important;
}

.brat-editor-card.editable * {
  cursor: text !important;
}

/* Pesan untuk viewer */
.viewer-notice {
  display: none;
  text-align: center;
  padding: 20px;
  color: #888;
  font-style: italic;
  font-size: 14px;
}

body:not(.logged-in) .viewer-notice {
  display: block;
}
</style>
</head>

<body class="page-brat">

<header class="site-header small">
  <h1 class="brat">BRAT</h1>
  <nav class="main-nav">
    <a href="index.html" class="menu-btn">HOME</a> 
    <a href="art.html" class="menu-btn">ART</a>
    <a href="yapper.html" class="menu-btn">YAPS</a>
  </nav>
</header>

<div class="editor-toolbar-fixed" id="toolbar-brat">
  <select id="fontSelect-brat" aria-label="Font">
    <option value="monospace">Monospace</option>
    <option value="serif">Serif</option>
    <option value="sans-serif">Sans</option>
    <option value="Doto">Doto</option>
    <option value="Quantico">Quantico</option>
  </select>

  <select id="sizeSelect-brat" aria-label="Size">
    <option value="14">14px</option>
    <option value="16" selected>16px</option>
    <option value="20">20px</option>
    <option value="24">24px</option>
  </select>
  
  <button type="button" data-cmd="bold" aria-label="Bold"><b>B</b></button>
  <button type="button" data-cmd="italic" aria-label="Italic"><i>I</i></button>
  <button type="button" data-cmd="underline" aria-label="Underline"><u>U</u></button>

  <input type="color" id="color-brat" value="#4FC3F7" aria-label="Color"/>

  <button type="button" data-cmd="justifyLeft" aria-label="Left">L</button>
  <button type="button" data-cmd="justifyCenter" aria-label="Center">C</button>
  <button type="button" data-cmd="justifyRight" aria-label="Right">R</button>
  <button type="button" data-cmd="outdent" aria-label="Outdent">&lt;</button>
  <button type="button" data-cmd="indent" aria-label="Indent">&gt;</button>

  <button id="addImageBrat" type="button">IMG</button>
  <button id="saveBrat" type="button">SAVE</button>
</div>

<main class="content-wrap">
  <article id="bratEditor" class="brat-editor-card view-only" tabindex="0"></article>
  <div class="viewer-notice">
    Hanya admin yang dapat mengedit konten ini. Untuk mengedit, silakan login terlebih dahulu.
  </div>
  <input type="file" id="imageInputBrat" accept="image/*" style="display:none" />
</main>

<button id="adminToggle" class="admin-toggle admin-toggle-center" aria-live="polite">outsider</button>

<script src="app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ==========================================================
// DEBUG LOGS
// ==========================================================
console.log('=== BRAT PAGE LOADED ===');

// ==========================================================
// SUPABASE INITIALIZATION
// ==========================================================
const supabaseUrl = 'https://exnzopxpseoztfhrtrxj.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4bnpvcHhwc2VvenRmaHJ0cnhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MzgyNzIsImV4cCI6MjA4MTAxNDI3Mn0.x6oP9AfSFd0LuaQxCHmBLzcD23CGO8BA0iMkubtkG24';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

console.log('Supabase client created:', !!supabase);

// ==========================================================
// DOM ELEMENTS
// ==========================================================
const toolbar = document.getElementById("toolbar-brat");
const editor = document.getElementById("bratEditor");
const saveBtn = document.getElementById("saveBrat");
const addImageBtn = document.getElementById("addImageBrat");
const imageInput = document.getElementById("imageInputBrat");
const adminToggle = document.getElementById("adminToggle");

console.log('DOM elements:', {
  toolbar: !!toolbar,
  editor: !!editor,
  saveBtn: !!saveBtn,
  adminToggle: !!adminToggle
});

// ==========================================================
// TEST SUPABASE CONNECTION
// ==========================================================
async function testSupabase() {
  try {
    console.log('Testing Supabase connection...');
    
    const { data: tables, error: tablesError } = await supabase
      .from('content')
      .select('*')
      .limit(1);
    
    if (tablesError) {
      console.error('Table error:', tablesError);
      return false;
    }
    
    console.log('Table exists, rows:', tables?.length || 0);
    
    return true;
  } catch (error) {
    console.error('Connection test failed:', error);
    return false;
  }
}

// ==========================================================
// LOAD FROM SUPABASE (FIXED VERSION)
// ==========================================================
async function loadBratContent() {
  console.log('Loading BRAT content...');
  
  try {
    const { data, error } = await supabase
      .from('content')
      .select('*')
      .eq('page', 'brat')
      .single();
    
    console.log('Load response:', { data, error });
    
    if (error) {
      if (error.code === 'PGRST116') {
        console.log('No BRAT row found, will create when first saved');
        editor.innerHTML = '<p>Mulai menulis di sini...</p>';
        return;
      }
      throw error;
    }
    
    let content = '';
    if (data.brat_content) {
      content = data.brat_content;
    } else if (data.content) {
      content = data.content;
    } else if (data.data) {
      content = data.data;
    }
    
    console.log('Content to load:', content.substring(0, 50) + '...');
    
    if (content) {
      editor.innerHTML = content;
    } else {
      editor.innerHTML = '<p>Mulai menulis di sini...</p>';
    }
    
  } catch (error) {
    console.error('Error loading BRAT content:', error);
    editor.innerHTML = '<p>Error loading content. Please refresh.</p>';
  }
}

// ==========================================================
// SAVE TO SUPABASE (FIXED VERSION)
// ==========================================================
async function saveBratContent() {
  console.log('Attempting to save BRAT content...');
  
  if (!editor.isContentEditable) {
    alert("⚠️ You must be logged in to save.");
    return;
  }
  
  const html = editor.innerHTML.trim();
  console.log('Content to save length:', html.length);
  
  if (!html) {
    alert("⚠️ Content is empty!");
    return;
  }
  
  try {
    const { data: updateResult, error: updateError } = await supabase
      .from('content')
      .update({ 
        brat_content: html,
        content: html,
        updated_at: new Date().toISOString() 
      })
      .eq('page', 'brat');
    
    console.log('Update result:', { updateResult, updateError });
    
    if (updateError || !updateResult) {
      console.log('Update failed or no rows affected, trying insert...');
      
      const { data: insertResult, error: insertError } = await supabase
        .from('content')
        .insert([{ 
          page: 'brat', 
          brat_content: html,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        }])
        .select();
      
      console.log('Insert result:', { insertResult, insertError });
      
      if (insertError) throw insertError;
      
      alert("✅ BRAT content saved to Supabase! (New record created)");
    } else {
      alert("✅ BRAT content saved to Supabase! (Existing record updated)");
    }
    
    console.log('Save successful!');
    
  } catch (error) {
    console.error('Save error details:', error);
    alert("❌ Save failed: " + (error.message || 'Unknown error'));
  }
}

// ==========================================================
// AUTH + SHOW TOOLBAR (FIXED)
// ==========================================================
async function setupAuth() {
  try {
    const { data: { user }, error: userError } = await supabase.auth.getUser();
    
    if (userError) {
      console.error('Auth error:', userError);
      return;
    }
    
    const isLoggedIn = !!user;
    console.log('Auth state:', isLoggedIn ? 'LOGGED IN' : 'LOGGED OUT', user);
    
    document.body.classList.toggle("logged-in", isLoggedIn);
    adminToggle.textContent = isLoggedIn ? "do it" : "outsider";
    
    if (isLoggedIn) {
      // ADMIN MODE: Show toolbar and enable editing
      toolbar.style.display = "flex";
      editor.contentEditable = "true";
      editor.classList.remove("view-only");
      editor.classList.add("editable");
      console.log('Editor enabled for editing (ADMIN MODE)');
    } else {
      // VIEWER MODE: Hide toolbar and disable editing
      toolbar.style.display = "none";
      editor.contentEditable = "false";
      editor.classList.remove("editable");
      editor.classList.add("view-only");
      
      // Disable all editing interactions for viewer
      editor.style.pointerEvents = "none";
      editor.style.cursor = "default";
      console.log('Editor disabled (VIEWER MODE)');
    }
    
  } catch (error) {
    console.error('Auth setup error:', error);
  }
}

// Auth state change listener
supabase.auth.onAuthStateChange((event, session) => {
  console.log('Auth state changed:', event, session);
  setupAuth();
});

// ==========================================================
// EVENT LISTENERS
// ==========================================================

// Save button - only works when logged in
if (saveBtn) {
  saveBtn.addEventListener("click", saveBratContent);
  console.log('Save button listener added');
}

// Toolbar commands - only work when logged in
if (toolbar) {
  toolbar.addEventListener("click", (e) => {
    // Check if user is logged in
    if (!editor.isContentEditable) {
      alert("Please login to edit content");
      return;
    }
    
    const btn = e.target.closest("button");
    if (!btn) return;
    
    const cmd = btn.dataset.cmd;
    if (cmd) {
      editor.focus();
      document.execCommand(cmd, false, null);
      console.log('Toolbar command:', cmd);
      return;
    }
    
    if (btn.id === "addImageBrat") {
      imageInput.click();
      console.log('Add image clicked');
      return;
    }
  });
}

// Font controls - only work when logged in
const fontSelect = document.getElementById("fontSelect-brat");
const sizeSelect = document.getElementById("sizeSelect-brat");
const colorInput = document.getElementById("color-brat");

if (fontSelect) {
  fontSelect.addEventListener("change", (e) => {
    if (!editor.isContentEditable) return;
    editor.focus();
    document.execCommand("fontName", false, e.target.value);
  });
}

if (sizeSelect) {
  sizeSelect.addEventListener("change", (e) => {
    if (!editor.isContentEditable) return;
    const px = e.target.value + "px";
    editor.focus();
    document.execCommand("fontSize", false, "7");
    editor.querySelectorAll("font[size='7']").forEach(el => {
      el.removeAttribute("size");
      el.style.fontSize = px;
    });
  });
}

if (colorInput) {
  colorInput.addEventListener("input", (e) => {
    if (!editor.isContentEditable) return;
    editor.focus();
    document.execCommand("foreColor", false, e.target.value);
  });
}

// Image upload - only work when logged in
if (imageInput) {
  imageInput.addEventListener("change", async (e) => {
    if (!editor.isContentEditable) {
      alert("Please login to upload images");
      e.target.value = null;
      return;
    }
    
    const file = e.target.files[0];
    if (!file) return;
    
    console.log('Image selected:', file.name, file.size);
    
    try {
      const fileExt = file.name.split('.').pop();
      const fileName = `${Date.now()}_${Math.random().toString(36).substring(2)}.${fileExt}`;
      
      console.log('Uploading to Supabase Storage...');
      const { data, error } = await supabase.storage
        .from('images')
        .upload(fileName, file);
      
      if (error) throw error;
      
      const { data: { publicUrl } } = supabase.storage
        .from('images')
        .getPublicUrl(fileName);
      
      console.log('Image uploaded, URL:', publicUrl);
      
      editor.focus();
      document.execCommand("insertImage", false, publicUrl);
      
      await saveBratContent();
      
    } catch (error) {
      console.error('Image upload error:', error);
      alert("❌ Image upload failed: " + error.message);
    } finally {
      e.target.value = null;
    }
  });
}

// Admin toggle
if (adminToggle) {
  adminToggle.addEventListener("click", async () => {
    console.log('Admin toggle clicked');
    
    const { data: { user } } = await supabase.auth.getUser();
    
    if (user) {
      try { 
        await supabase.auth.signOut();
        alert("Signed out");
        console.log('Signed out');
      } catch(err) { 
        console.error('Sign-out error:', err);
        alert("Sign-out failed: " + err.message); 
      }
      return;
    }
    
    alert("Please login on the HOME page.");
    window.location.href = "index.html";
  });
}

// Prevent editing for viewers by disabling all edit events
function preventViewerEditing() {
  editor.addEventListener('keydown', (e) => {
    if (!editor.isContentEditable) {
      e.preventDefault();
      return false;
    }
  });
  
  editor.addEventListener('paste', (e) => {
    if (!editor.isContentEditable) {
      e.preventDefault();
      return false;
    }
  });
  
  editor.addEventListener('cut', (e) => {
    if (!editor.isContentEditable) {
      e.preventDefault();
      return false;
    }
  });
  
  editor.addEventListener('dragstart', (e) => {
    if (!editor.isContentEditable) {
      e.preventDefault();
      return false;
    }
  });
  
  editor.addEventListener('drop', (e) => {
    if (!editor.isContentEditable) {
      e.preventDefault();
      return false;
    }
  });
}

// ==========================================================
// INITIALIZATION
// ==========================================================
async function initialize() {
  console.log('Initializing BRAT page...');
  
  const connected = await testSupabase();
  console.log('Supabase connected:', connected);
  
  if (!connected) {
    alert('⚠️ Cannot connect to database. Check console for details.');
  }
  
  await setupAuth();
  await loadBratContent();
  preventViewerEditing(); // Add protection against viewer editing
  
  console.log('BRAT page initialized successfully');
}

// Start initialization
document.addEventListener('DOMContentLoaded', initialize);
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    document.body.classList.add("bokeh-blur");
    setTimeout(() => {
        document.body.classList.remove("bokeh-blur");
    }, 600);
});
</script>
</body>
</html>
