<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BRAT — EW</title>
<link rel="stylesheet" href="style.css" />

<style>
/* =====================================================
   BRAT — CLEAN DARK LAYOUT (FULL WIDTH SYNCHRONIZED)
   FIXED SMOOTH TOOLBAR + MOBILE HORIZONTAL SCROLL
   & RICH-EDITOR COMPAT (desktop + mobile)
===================================================== */

/* Variables */
:root {
  --gutter: 40px;
  --header-h: 170px;
  --footer-h: 40px;
  --toolbar-gap: 10px;
        /* Glassmorphism Effect */
            --glass-bg-primary: rgba(255, 255, 255, 0.051); 
            --glass-bg: rgba(255, 255, 255, 0.033); 
            --glass-border: rgba(255, 255, 255, 0.115);
            --glass-shadow-primary: rgba(0, 0, 0, 0.3); 
            --text-color-light: #f1f1f1;
        }

/* Body */
body.page-brat {
  position: relative; /* reference untuk ::before */
  overflow-x: hidden;
  min-height: 100vh;
  color: #d6d6d6;
  font-family: "Doto", sans-serif;
  background: none; /* hapus background global */
}

body.page-brat::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-image: url('asset/bratdesktop.png');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  z-index: -1;
}

/* Background mobile */
@media (max-width: 720px) {
  body.page-brat::before {
    background-image: url('asset/bratmobile.png');
    background-size: cover;
    background-position: center top;
    z-index: -1;
  }
}

/* Full width content (shifted down to leave space for toolbar) */
        .content-wrap {
            position: absolute;
            top: var(--header-h);
            left: 220px; 
            right: 220px; 
            bottom: 40px;
            transition: left .28s ease;
            overflow: hidden;
            padding: 18px;
        }
/* Editor container */
.brat-editor-card {
            width: 100%;
            height: 100%;
            background: var(--glass-bg-primary);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border-radius: 18px;
            border: 1px solid var(--glass-border);
            padding: 26px;
            overflow-y: auto;
            box-shadow: 0 8px 32px 0 var(--glass-shadow-primary), inset 0 0 0 1px rgba(255,255,255,0.1);
            color: #dcdcdc;
            line-height: 1.6;
        


  /* Rich edit compatibility */
  -webkit-user-modify: read-write; /* enable editing on iOS */
  -webkit-user-select: text;
  user-select: text;
  outline: none;
  -webkit-tap-highlight-color: transparent;
}

/* Make article focusable for editor.focus() */
.brat-editor-card:focus { box-shadow: 0 0 0 2px rgba(220, 234, 241, 0.429) inset; }

/* =====================================================
   FIXED FLOATING TOOLBAR (SMOOTH)
===================================================== */
.editor-toolbar-fixed {
  position: fixed;
  top: calc(var(--header-h) + -30px); /* diperbaiki: 10px below header */
  left: 50%;
  transform: translateX(-50%);
  width: fit-content;

  background: rgba(20,20,20,0.92);
  border: 1px solid rgba(255,255,255,0.10);
  padding: 10px 14px;
  border-radius: 12px;
  display: flex;
  gap: var(--toolbar-gap);
  align-items: center;
  z-index: 9999;
  backdrop-filter: blur(6px);
  transition: box-shadow .18s ease, transform .18s ease, opacity .18s ease;
}

/* Shadow when scrolling */
.editor-toolbar-fixed.scrolled {
  box-shadow: 0 8px 32px rgba(0,0,0,0.6);
  transform: translate(-50%, 4px);
}

/* Buttons / selects */
.editor-toolbar-fixed select,
.editor-toolbar-fixed button,
.editor-toolbar-fixed input[type="color"] {
  background: rgba(255,255,255,0.04);
  color: #e8e8e8;
  border: 1px solid rgba(255,255,255,0.08);
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  white-space: nowrap;
}

.editor-toolbar-fixed button:hover {
  background: rgba(255,255,255,0.10);
}

/* Desktop layout remains centered */
@media (min-width: 721px) {
  .editor-toolbar-fixed { width: fit-content; left: 50%; transform: translateX(-50%); border-radius: 12px; }
}

/* =====================================================
   MOBILE: toolbar becomes horizontal scrollable bar
===================================================== */
@media (max-width:720px) {
        .content-wrap {
            left: 30px; 
            right: 30px;
            top: calc(var(--header-h) + 60px);
            bottom: 65px;
            padding: 10px; /* Padding sedikit disesuaikan untuk mobile */
        }

  .editor-toolbar-fixed {
            position: fixed;
            top: calc(var(--header-h) + 15px); 
            left: 0;
            right: 0;
            transform: none;
            width: 100%;
            padding: 8px 12px;
            border-radius: 0;
            background: rgba(18,18,18,0.92);
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
  }

  .editor-toolbar-fixed::-webkit-scrollbar { height: 6px; }
  .editor-toolbar-fixed::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 6px; }

  .editor-toolbar-fixed select,
  .editor-toolbar-fixed button,
  .editor-toolbar-fixed input[type="color"] {
    display: inline-block;
    margin-right: 8px;
  }
}

/* Small adjustments */
.editor-toolbar-fixed select { min-width: 88px; }
.editor-toolbar-fixed input[type="color"] { padding: 6px; width: 40px; }

/* =====================================================
   EXTRA: READ-ONLY PROTECTION STYLES
===================================================== */
.brat-editor-card.read-only {
  /* Completely disable interactions */
  pointer-events: none !important;
  user-select: none !important;
  -webkit-user-select: none !important;
  -moz-user-select: none !important;
  -ms-user-select: none !important;
  
  /* Visual indicator */
  position: relative;
  cursor: not-allowed !important;
}

.brat-editor-card.read-only::after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: transparent;
  z-index: 1;
  cursor: not-allowed !important;
}

/* Show login prompt on hover */
.brat-editor-card.read-only:hover::before {
  content: "Login as admin to edit";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.85);
  color: #fff;
  padding: 12px 20px;
  border-radius: 8px;
  font-family: "Quantico", sans-serif;
  font-size: 14px;
  z-index: 100;
  pointer-events: none;
  white-space: nowrap;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

/* Disable all interactions with content */
.brat-editor-card.read-only * {
  pointer-events: none !important;
  cursor: not-allowed !important;
}

/* Specifically disable images */
.brat-editor-card.read-only img {
  pointer-events: none !important;
  -webkit-user-drag: none !important;
  -khtml-user-drag: none !important;
  -moz-user-drag: none !important;
  -o-user-drag: none !important;
  user-drag: none !important;
}
/* ADMIN TOGGLE: dihapus karena sudah ada di style.css */
</style>
</head>


<body class="page-brat">

<header class="site-header small">
  <h1 class="brat">BRAT</h1>
  <nav class="main-nav">
    <a href="index.html" class="menu-btn">HOME</a> 
    <a href="art.html" class="menu-btn">ART</a>
    <a href="yapper.html" class="menu-btn">YAPS</a>
  </nav>
</header>


<div class="editor-toolbar-fixed" id="toolbar-brat" style="display:none;">
  <select id="fontSelect-brat" aria-label="Font">
    <option value="monospace">Monospace</option>
    <option value="serif">Serif</option>
    <option value="sans-serif">Sans</option>
    <option value="Doto">Doto</option>
    <option value="Quantico">Quantico</option>
  </select>

  <select id="sizeSelect-brat" aria-label="Size">
    <option value="14">14px</option>
    <option value="16" selected>16px</option>
    <option value="20">20px</option>
    <option value="24">24px</option>
  </select>
  
  <button type="button" data-cmd="bold" aria-label="Bold"><b>B</b></button>
  <button type="button" data-cmd="italic" aria-label="Italic"><i>I</i></button>
  <button type="button" data-cmd="underline" aria-label="Underline"><u>U</u></button>

  <input type="color" id="color-brat" value="#4FC3F7" aria-label="Color"/>

  <button type="button" data-cmd="justifyLeft" aria-label="Left">L</button>
  <button type="button" data-cmd="justifyCenter" aria-label="Center">C</button>
  <button type="button" data-cmd="justifyRight" aria-label="Right">R</button>
  <button type="button" data-cmd="outdent" aria-label="Outdent">&lt;</button>
  <button type="button" data-cmd="indent" aria-label="Indent">&gt;</button>

  <button id="addImageBrat" type="button">IMG</button>
  <button id="saveBrat" type="button">SAVE</button>
</div>


<main class="content-wrap">
  <article id="bratEditor" class="brat-editor-card editable" contenteditable="false" tabindex="0"></article>
  <input type="file" id="imageInputBrat" accept="image/*" style="display:none" />
</main>

<button id="adminToggle" class="admin-toggle admin-toggle-center" aria-live="polite">outsider</button>

// ==========================================================
// COMPLETE FIXED SCRIPT SECTION
// ==========================================================
<script src="app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ==========================================================
// SUPABASE INITIALIZATION
// ==========================================================
const supabaseUrl = 'https://exnzopxpseoztfhrtrxj.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4bnpvcHhwc2VvenRmaHJ0cnhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MzgyNzIsImV4cCI6MjA4MTAxNDI3Mn0.x6oP9AfSFd0LuaQxCHmBLzcD23CGO8BA0iMkubtkG24';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// ==========================================================
// DOM ELEMENTS
// ==========================================================
const toolbar = document.getElementById("toolbar-brat");
const editor = document.getElementById("bratEditor");
const saveBtn = document.getElementById("saveBrat");
const addImageBtn = document.getElementById("addImageBrat");
const imageInput = document.getElementById("imageInputBrat");
const adminToggle = document.getElementById("adminToggle");

// ==========================================================
// PROTECTION FUNCTIONS
// ==========================================================
function enableEditing() {
  // Enable for admin
  editor.contentEditable = "true";
  editor.classList.add("editable");
  editor.classList.remove("read-only");
  editor.style.userSelect = "text";
  editor.style.webkitUserSelect = "text";
  editor.style.cursor = "text";
  toolbar.style.display = "flex";
  
  // Re-enable event listeners
  editor.onclick = null;
  editor.onkeydown = null;
  editor.oninput = null;
}

function disableEditing() {
  // Disable for non-admin
  editor.contentEditable = "false";
  editor.classList.remove("editable");
  editor.classList.add("read-only");
  editor.style.userSelect = "none";
  editor.style.webkitUserSelect = "none";
  editor.style.cursor = "default";
  toolbar.style.display = "none";
  
  // Prevent all editing attempts
  editor.onclick = function(e) {
    e.preventDefault();
    e.stopPropagation();
    return false;
  };
  
  editor.onkeydown = function(e) {
    e.preventDefault();
    e.stopPropagation();
    return false;
  };
  
  editor.oninput = function(e) {
    e.preventDefault();
    e.stopPropagation();
    return false;
  };
  
  // Prevent drag-and-drop
  editor.ondragstart = function(e) {
    e.preventDefault();
    return false;
  };
  
  editor.ondrop = function(e) {
    e.preventDefault();
    return false;
  };
}

// ==========================================================
// LOAD FROM SUPABASE
// ==========================================================
async function loadBratContent() {
  try {
    const { data, error } = await supabase
      .from('content')
      .select('brat_content')
      .eq('page', 'brat')
      .maybeSingle();
    
    if (error && error.code !== 'PGRST116') {
      console.error('Load error:', error);
      return;
    }
    
    if (data && data.brat_content) {
      editor.innerHTML = data.brat_content;
    }
    
  } catch (error) {
    console.error('Error loading BRAT content:', error);
  }
}

// ==========================================================
// SAVE TO SUPABASE (USING UPSERT)
// ==========================================================
async function saveBratContent() {
  // Double check authentication
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    alert("⚠️ You must be logged in to save.");
    disableEditing(); // Force disable
    return;
  }
  
  const html = editor.innerHTML.trim();
  
  if (html === '') {
    alert("⚠️ Content is empty!");
    return;
  }
  
  try {
    // Use upsert
    const { error } = await supabase
      .from('content')
      .upsert({ 
        page: 'brat',
        brat_content: html,
        updated_at: new Date().toISOString()
      }, {
        onConflict: 'page'
      });
    
    if (error) throw error;
    
    alert("✅ BRAT content saved!");
    
  } catch (error) {
    console.error('Save error:', error);
    alert("❌ Save failed: " + error.message);
  }
}

// ==========================================================
// AUTH MANAGEMENT
// ==========================================================
async function checkAndApplyAuth() {
  const { data: { user } } = await supabase.auth.getUser();
  const isLoggedIn = !!user;
  
  document.body.classList.toggle("logged-in", isLoggedIn);
  adminToggle.textContent = isLoggedIn ? "do it" : "outsider";
  
  if (isLoggedIn) {
    enableEditing();
  } else {
    disableEditing();
  }
}

// Auth state listener
supabase.auth.onAuthStateChange((event, session) => {
  console.log('Auth changed:', event);
  checkAndApplyAuth();
});

// ==========================================================
// EVENT LISTENERS (ADMIN ONLY)
// ==========================================================

// Save button - only works when logged in
saveBtn.addEventListener("click", async (e) => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    e.preventDefault();
    alert("⚠️ Login required");
    return;
  }
  saveBratContent();
});

// Toolbar commands - only when editable
toolbar.addEventListener("click", (e) => {
  if (editor.contentEditable !== "true") {
    e.preventDefault();
    e.stopPropagation();
    return;
  }
  
  const btn = e.target.closest("button");
  if (!btn) return;
  
  const cmd = btn.dataset.cmd;
  if (cmd) {
    editor.focus();
    document.execCommand(cmd, false, null);
    return;
  }
  
  if (btn.id === "addImageBrat") {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      alert("⚠️ Login required");
      return;
    }
    imageInput.click();
    return;
  }
});

// Font controls - protected
document.getElementById("fontSelect-brat").addEventListener("change", async (e) => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    e.preventDefault();
    return;
  }
  if (editor.contentEditable === "true") {
    editor.focus();
    document.execCommand("fontName", false, e.target.value);
  }
});

document.getElementById("sizeSelect-brat").addEventListener("change", async (e) => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    e.preventDefault();
    return;
  }
  if (editor.contentEditable === "true") {
    const px = e.target.value + "px";
    editor.focus();
    document.execCommand("fontSize", false, "7");
    editor.querySelectorAll("font[size='7']").forEach(el => {
      el.removeAttribute("size");
      el.style.fontSize = px;
    });
  }
});

document.getElementById("color-brat").addEventListener("input", async (e) => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    e.preventDefault();
    return;
  }
  if (editor.contentEditable === "true") {
    editor.focus();
    document.execCommand("foreColor", false, e.target.value);
  }
});

// Image upload - protected
imageInput.addEventListener("change", async (e) => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    e.preventDefault();
    e.target.value = null;
    alert("⚠️ Login required");
    return;
  }
  
  const file = e.target.files[0];
  if (!file) return;
  
  try {
    const fileExt = file.name.split('.').pop();
    const fileName = `${Date.now()}_${Math.random().toString(36).substring(2)}.${fileExt}`;
    
    const { data, error } = await supabase.storage
      .from('images')
      .upload(fileName, file);
    
    if (error) throw error;
    
    const { data: { publicUrl } } = supabase.storage
      .from('images')
      .getPublicUrl(fileName);
    
    editor.focus();
    document.execCommand("insertImage", false, publicUrl);
    
    await saveBratContent();
    
  } catch (error) {
    console.error('Image upload error:', error);
    alert("❌ Image upload failed: " + error.message);
  } finally {
    e.target.value = null;
  }
});

// Admin toggle
adminToggle.addEventListener("click", async () => {
  const { data: { user } } = await supabase.auth.getUser();
  
  if (user) {
    try { 
      await supabase.auth.signOut();
      alert("Signed out");
      disableEditing(); // Immediately disable editing
    } catch(err) { 
      alert("Sign-out failed: " + err.message); 
    }
    return;
  }
  
  alert("Please login on the HOME page.");
  window.location.href = "index.html";
});

// ==========================================================
// INITIALIZATION
// ==========================================================
async function initialize() {
  // Start in disabled mode by default
  disableEditing();
  
  // Check auth and apply appropriate mode
  await checkAndApplyAuth();
  
  // Load content
  await loadBratContent();
  
  // Animation
  document.body.classList.add("bokeh-blur");
  setTimeout(() => {
    document.body.classList.remove("bokeh-blur");
  }, 600);
}

// Start
document.addEventListener('DOMContentLoaded', initialize);

// Extra protection on page interactions
document.addEventListener('keydown', function(e) {
  // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
  if (
    e.key === 'F12' ||
    (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) ||
    (e.ctrlKey && e.key === 'u')
  ) {
    e.preventDefault();
  }
}, false);
</script>
</body>
</html>
