<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>send or burn Project</title>

  <!-- Quill Rich Text Editor -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
  
  <!-- html2canvas untuk konversi ke gambar -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <nav class="main-nav a">
    <button class="menu-btn" data-target="brat.html">BRAT</button>
    <button class="menu-btn" data-target="art.html">ART</button>
    <button class="menu-btn" data-target="yapper.html">YAPS</button>
  <style>
    /* [CSS tetap sama seperti sebelumnya] */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'MS Sans Serif', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1b1b1b;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="white"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="gray" stroke-width="1"/></svg>');
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      width: 100%;
      max-width: 900px;
    }

    .window {
      width: 500px;
      background: #c0c0c0;
      border: 2px solid;
      border-color: #dfdfdf #000000 #000000 #dfdfdf;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
      margin-bottom: 20px;
    }

    .title-bar {
      background: linear-gradient(90deg, #000080, #1084d0);
      color: white;
      padding: 3px 5px;
      font-weight: bold;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 22px;
      border-bottom: 2px solid #000000;
    }

    .title-text {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .window-controls {
      display: flex;
      gap: 2px;
    }

    .window-btn {
      width: 18px;
      height: 16px;
      background: #c0c0c0;
      border: 1px solid;
      border-color: #dfdfdf #000000 #000000 #dfdfdf;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .window-btn:active {
      border-color: #000000 #dfdfdf #dfdfdf #000000;
    }

    .menu-bar {
      background: #c0c0c0;
      padding: 2px 5px;
      border-bottom: 2px solid #000000;
      font-size: 12px;
      display: flex;
      gap: 15px;
    }

    .menu-item {
      padding: 2px 5px;
      cursor: default;
    }

    .menu-item:hover {
      background: #000080;
      color: white;
    }

    .card-window {
      width: 400px;
      background: white;
      border: 2px solid;
      border-color: #000000 #dfdfdf #dfdfdf #000000;
      margin: 15px auto;
      position: relative;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #c0c0c0;
      padding: 5px 10px;
      border-bottom: 2px solid #000000;
      font-weight: bold;
      font-size: 14px;
    }

    .recipient-input {
      background: transparent;
      border: none;
      border-bottom: 1px dotted #000;
      font-family: inherit;
      font-size: inherit;
      font-weight: normal;
      width: 150px;
      padding: 1px 3px;
      margin-left: 5px;
    }

    .recipient-input:focus {
      outline: none;
      background: #ffffe0;
    }

    .card-body {
      background: var(--card-color, #7b8464);
      min-height: 300px;
      padding: 15px;
      color: white;
    }

    #message-editor {
      min-height: 250px;
      font-size: 18px;
      line-height: 1.5;
      outline: none;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      overflow-wrap: break-word;
      white-space: pre-wrap;
    }

    #message-editor:empty::before {
      content: attr(placeholder);
      color: rgba(255, 255, 255, 0.6);
      font-style: italic;
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      background: #c0c0c0;
      padding: 8px 15px;
      border-top: 2px solid #000000;
      font-weight: bold;
      font-size: 14px;
    }

    .footer-btn {
      padding: 3px 10px;
      background: #c0c0c0;
      border: 2px solid;
      border-color: #dfdfdf #000000 #000000 #dfdfdf;
      cursor: pointer;
      font-family: inherit;
      font-weight: bold;
      font-size: 13px;
    }

    .footer-btn:active {
      border-color: #000000 #dfdfdf #dfdfdf #000000;
    }

    .send-btn {
      color: #000080;
    }

    .burn-btn {
      color: #800000;
    }

    .format-window {
      width: 500px;
      margin-top: 20px;
    }

    .format-toolbar {
      background: #c0c0c0;
      padding: 8px;
      border: 2px solid;
      border-color: #dfdfdf #000000 #000000 #dfdfdf;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: center;
    }

    .format-btn {
      width: 24px;
      height: 24px;
      background: #c0c0c0;
      border: 2px solid;
      border-color: #dfdfdf #000000 #000000 #dfdfdf;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .format-btn:active {
      border-color: #000000 #dfdfdf #dfdfdf #000000;
    }

    .format-btn.active {
      background: #000080;
      color: white;
      border-color: #000000 #dfdfdf #dfdfdf #000000;
    }

    .color-picker-btn {
      position: relative;
      width: 30px;
      height: 24px;
    }

    .color-box {
      width: 20px;
      height: 15px;
      border: 1px solid #000;
      margin: 0 auto;
    }

    .controls-window {
      width: 500px;
      margin-top: 20px;
    }

    .controls-body {
      background: white;
      padding: 15px;
      border: 2px solid;
      border-color: #000000 #dfdfdf #dfdfdf #000000;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 15px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .control-label {
      font-size: 13px;
      font-weight: bold;
    }

    .win-color-input {
      width: 50px;
      height: 30px;
      border: 2px solid;
      border-color: #000000 #dfdfdf #dfdfdf #000000;
      cursor: pointer;
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      width: 100%;
      margin-top: 15px;
    }

    .win-btn {
      padding: 8px 20px;
      background: #c0c0c0;
      border: 2px solid;
      border-color: #dfdfdf #000000 #000000 #dfdfdf;
      cursor: pointer;
      font-family: inherit;
      font-weight: bold;
      font-size: 14px;
      min-width: 140px;
    }

    .win-btn:active {
      border-color: #000000 #dfdfdf #dfdfdf #000000;
    }

    .win-btn.save {
      background: #000080;
      color: white;
    }

    .win-btn.burn {
      background: #800000;
      color: white;
    }

    .win-btn.reset {
      background: #808080;
      color: white;
    }

    .status-bar {
      background: #c0c0c0;
      padding: 3px 10px;
      border-top: 2px solid #000000;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
    }

    .burning {
      position: relative;
      overflow: hidden;
    }

    .burning::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, 
        transparent 10%, 
        rgba(255, 165, 0, 0.3) 20%, 
        rgba(255, 69, 0, 0.5) 30%, 
        rgba(139, 0, 0, 0.7) 40%, 
        rgba(0, 0, 0, 0.9) 50%, 
        transparent 100%);
      z-index: 10;
      animation: burn 3s forwards;
      pointer-events: none;
    }

    .burning::after {
      content: 'üî•';
      position: absolute;
      font-size: 40px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 11;
      animation: fire 3s forwards;
      pointer-events: none;
    }

    @keyframes burn {
      0% {
        height: 0%;
        opacity: 0;
      }
      20% {
        opacity: 0.5;
      }
      50% {
        opacity: 1;
      }
      80% {
        opacity: 0.8;
      }
      100% {
        height: 100%;
        opacity: 0;
      }
    }

    @keyframes fire {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5);
      }
      20% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      50% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.2);
      }
      80% {
        opacity: 0.5;
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5);
      }
    }

    .message-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #c0c0c0;
      border: 2px solid;
      border-color: #dfdfdf #000000 #000000 #dfdfdf;
      z-index: 1000;
      display: none;
      width: 300px;
    }

    .message-dialog.show {
      display: block;
    }

    .dialog-title {
      background: #000080;
      color: white;
      padding: 5px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
    }

    .dialog-body {
      padding: 20px;
      text-align: center;
      font-size: 14px;
    }

    .dialog-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      padding: 10px;
    }

    .preview-window {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #c0c0c0;
      border: 3px solid;
      border-color: #dfdfdf #000000 #000000 #dfdfdf;
      z-index: 1001;
      display: none;
      width: 450px;
    }

    .preview-window.show {
      display: block;
    }

    .preview-image {
      width: 100%;
      display: block;
      border: 2px solid #000;
    }

    .preview-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 15px;
    }

    /* Auto-save indicator */
    .save-indicator {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #000080;
      color: white;
      padding: 5px 10px;
      border-radius: 3px;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1002;
    }

    .save-indicator.show {
      opacity: 1;
    }

    @media (max-width: 600px) {
      .window, .format-window, .controls-window {
        width: 95%;
      }
      
      .card-window {
        width: 90%;
      }
      
      .controls-body {
        flex-direction: column;
        align-items: center;
      }
      
      .action-buttons {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>

  <!-- Auto-save indicator -->
  <div class="save-indicator" id="save-indicator">Auto-saved</div>

  <div class="container">
    <!-- Main Editor Window -->
    <div class="window">
      <div class="title-bar">
        <div class="title-text">
          <span>‚úâÔ∏è</span>
          <span>Send or Burn Project</span>
        </div>
        <div class="window-controls">
          <div class="window-btn">_</div>
          <div class="window-btn">‚ñ°</div>
          <div class="window-btn">√ó</div>
        </div>
      </div>
      
      <!-- Main Card -->
      <div class="card-window" id="card">
        <div class="card-header">
          <div>Send <span>To:</span> 
            <input type="text" class="recipient-input" id="recipient-input" value="whatever" maxlength="20">
          </div>
          <div>‚úâ</div>
        </div>
        
        <div class="card-body" id="card-body">
          <div id="message-editor" 
               contenteditable="true" 
               placeholder="Type your unsent message here...">
          </div>
        </div>
        
        <div class="card-footer">
          <button class="footer-btn send-btn" id="send-btn">Send</button>
          <div>#sendorburnproject</div>
          <button class="footer-btn burn-btn" id="burn-btn">Burn</button>
        </div>
      </div>
      
      <!-- Formatting Toolbar Window -->
      <div class="format-window">
        <div class="title-bar">
          <div class="title-text">Text Formatting</div>
        </div>
        <div class="format-toolbar">
          <button class="format-btn" id="bold-btn" title="Bold">B</button>
          <button class="format-btn" id="italic-btn" title="Italic">I</button>
          <button class="format-btn" id="underline-btn" title="Underline">U</button>
          <div style="width: 10px;"></div>
          <button class="format-btn" id="align-left-btn" title="Align Left">‚Ü∞</button>
          <button class="format-btn" id="align-center-btn" title="Center">‚Üî</button>
          <button class="format-btn" id="align-right-btn" title="Align Right">‚Ü±</button>
          <div style="width: 10px;"></div>
          <button class="format-btn color-picker-btn" id="text-color-btn" title="Text Color">
            <div class="color-box" style="background-color: #ffffff;"></div>
          </button>
          <input type="color" id="text-color-input" class="win-color-input" value="#ffffff" style="display: none;">
          <div style="width: 10px;"></div>
          <button class="format-btn" id="increase-size-btn" title="Increase Font Size">A+</button>
          <button class="format-btn" id="decrease-size-btn" title="Decrease Font Size">A-</button>
          <button class="format-btn" id="clear-format-btn" title="Clear Formatting">‚úï</button>
        </div>
      </div>
      
      <!-- Controls Window -->
      <div class="controls-window">
        <div class="title-bar">
          <div class="title-text">Controls</div>
        </div>
        <div class="controls-body">
          <div class="control-group">
            <div class="control-label">Card Color</div>
            <input type="color" id="card-color-input" class="win-color-input" value="#7b8464">
          </div>
          
          <div class="control-group">
            <div class="control-label">Font Family</div>
            <select id="font-family-select" style="padding: 3px; border: 2px solid; border-color: #000000 #dfdfdf #dfdfdf #000000;">
              <option value="'Comic Sans MS', cursive">Comic Sans</option>
              <option value="'Courier New', monospace">Courier New</option>
              <option value="Arial, sans-serif">Arial</option>
              <option value="'Times New Roman', serif">Times New Roman</option>
              <option value="Georgia, serif">Georgia</option>
            </select>
          </div>
          
          <div class="action-buttons">
            <button class="win-btn save" id="save-image-btn">üíæ Save as Image</button>
            <button class="win-btn burn" id="burn-effect-btn">üî• Burn Effect</button>
            <button class="win-btn reset" id="reset-btn">‚Üª Reset</button>
          </div>
        </div>
      </div>
      
      <div class="status-bar">
        <div id="save-status">Last saved: --</div>
        <div id="char-count">Characters: 0</div>
      </div>
    </div>
  </div>

  <!-- Message Dialog -->
  <div class="message-dialog" id="message-dialog">
    <div class="dialog-title">
      <span>Message</span>
      <span id="close-dialog-btn" style="cursor: pointer;">√ó</span>
    </div>
    <div class="dialog-body" id="dialog-message">
      Processing...
    </div>
    <div class="dialog-buttons">
      <button class="footer-btn" id="dialog-ok-btn">OK</button>
    </div>
  </div>

  <!-- Preview Window -->
  <div class="preview-window" id="preview-window">
    <div class="title-bar">
      <div class="title-text">Image Preview</div>
      <div class="window-controls">
        <div class="window-btn" id="close-preview-btn">√ó</div>
      </div>
    </div>
    <div class="dialog-body">
      <img id="preview-image" class="preview-image" src="" alt="Preview">
      <div class="preview-buttons">
        <a id="download-link" class="win-btn save" download="unsent-message.png" style="text-decoration: none; display: inline-block;">‚¨á Download</a>
        <button class="footer-btn" id="close-preview-btn2">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Elemen DOM
    const messageEditor = document.getElementById('message-editor');
    const recipientInput = document.getElementById('recipient-input');
    const cardBody = document.getElementById('card-body');
    const card = document.getElementById('card');
    const charCount = document.getElementById('char-count');
    const saveStatus = document.getElementById('save-status');
    const saveIndicator = document.getElementById('save-indicator');
    
    // Formatting buttons
    const boldBtn = document.getElementById('bold-btn');
    const italicBtn = document.getElementById('italic-btn');
    const underlineBtn = document.getElementById('underline-btn');
    const alignLeftBtn = document.getElementById('align-left-btn');
    const alignCenterBtn = document.getElementById('align-center-btn');
    const alignRightBtn = document.getElementById('align-right-btn');
    const textColorBtn = document.getElementById('text-color-btn');
    const textColorInput = document.getElementById('text-color-input');
    const increaseSizeBtn = document.getElementById('increase-size-btn');
    const decreaseSizeBtn = document.getElementById('decrease-size-btn');
    const clearFormatBtn = document.getElementById('clear-format-btn');
    
    // Color and font controls
    const cardColorInput = document.getElementById('card-color-input');
    const fontFamilySelect = document.getElementById('font-family-select');
    
    // Action buttons
    const sendBtn = document.getElementById('send-btn');
    const burnBtn = document.getElementById('burn-btn');
    const saveImageBtn = document.getElementById('save-image-btn');
    const burnEffectBtn = document.getElementById('burn-effect-btn');
    const resetBtn = document.getElementById('reset-btn');
    
    // Dialogs
    const messageDialog = document.getElementById('message-dialog');
    const dialogMessage = document.getElementById('dialog-message');
    const closeDialogBtn = document.getElementById('close-dialog-btn');
    const dialogOkBtn = document.getElementById('dialog-ok-btn');
    const previewWindow = document.getElementById('preview-window');
    const previewImage = document.getElementById('preview-image');
    const closePreviewBtn = document.getElementById('close-preview-btn');
    const closePreviewBtn2 = document.getElementById('close-preview-btn2');
    const downloadLink = document.getElementById('download-link');

    // Formatting state
    let currentFontSize = 18;
    let isBold = false;
    let isItalic = false;
    let isUnderline = false;
    let currentAlign = 'left';
    let currentTextColor = '#ffffff';
    let autoSaveTimer = null;
    let isSaving = false;

    // Local Storage Key
    const STORAGE_KEY = 'sendorburn_project_data';

    // ========== LOCAL STORAGE FUNCTIONS ==========

    // Save data to localStorage
    function saveToLocalStorage() {
      if (isSaving) return;
      
      isSaving = true;
      
      const data = {
        // Message content
        message: messageEditor.innerHTML,
        recipient: recipientInput.value,
        
        // Formatting
        formatting: {
          fontSize: currentFontSize,
          bold: isBold,
          italic: isItalic,
          underline: isUnderline,
          align: currentAlign,
          textColor: currentTextColor,
          fontFamily: fontFamilySelect.value
        },
        
        // Card appearance
        cardColor: cardColorInput.value,
        
        // Metadata
        lastSaved: new Date().toISOString(),
        version: '1.0'
      };
      
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        
        // Update save status
        const now = new Date();
        saveStatus.textContent = `Last saved: ${now.toLocaleTimeString()}`;
        
        // Show auto-save indicator
        saveIndicator.classList.add('show');
        setTimeout(() => {
          saveIndicator.classList.remove('show');
        }, 2000);
        
        console.log('Data saved to localStorage');
      } catch (error) {
        console.error('Error saving to localStorage:', error);
        showMessage('Storage is full. Clear some data or use private browsing.', 'error');
      }
      
      isSaving = false;
    }

    // Load data from localStorage
    function loadFromLocalStorage() {
      try {
        const savedData = localStorage.getItem(STORAGE_KEY);
        
        if (!savedData) {
          console.log('No saved data found');
          return false;
        }
        
        const data = JSON.parse(savedData);
        
        // Load message content
        if (data.message) messageEditor.innerHTML = data.message;
        if (data.recipient) recipientInput.value = data.recipient;
        
        // Load formatting
        if (data.formatting) {
          currentFontSize = data.formatting.fontSize || 18;
          isBold = data.formatting.bold || false;
          isItalic = data.formatting.italic || false;
          isUnderline = data.formatting.underline || false;
          currentAlign = data.formatting.align || 'left';
          currentTextColor = data.formatting.textColor || '#ffffff';
          
          if (data.formatting.fontFamily) {
            fontFamilySelect.value = data.formatting.fontFamily;
          }
          
          // Apply formatting
          applyFormatting();
        }
        
        // Load card color
        if (data.cardColor) {
          cardColorInput.value = data.cardColor;
          cardBody.style.setProperty('--card-color', data.cardColor);
        }
        
        // Update save status
        if (data.lastSaved) {
          const savedDate = new Date(data.lastSaved);
          saveStatus.textContent = `Last saved: ${savedDate.toLocaleTimeString()}`;
        }
        
        console.log('Data loaded from localStorage');
        return true;
      } catch (error) {
        console.error('Error loading from localStorage:', error);
        return false;
      }
    }

    // Clear localStorage
    function clearLocalStorage() {
      localStorage.removeItem(STORAGE_KEY);
      saveStatus.textContent = 'Last saved: --';
      showMessage('Local storage cleared.', 'info');
    }

    // Auto-save with debounce
    function triggerAutoSave() {
      if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
      }
      
      autoSaveTimer = setTimeout(() => {
        saveToLocalStorage();
      }, 1000); // Save 1 second after last change
    }

    // ========== UI FUNCTIONS ==========

    // Show message dialog
    function showMessage(message, type = 'info') {
      dialogMessage.textContent = message;
      messageDialog.classList.add('show');
      
      if (type === 'success') {
        dialogMessage.style.color = '#008000';
      } else if (type === 'error') {
        dialogMessage.style.color = '#800000';
      } else {
        dialogMessage.style.color = '#000080';
      }
    }

    // Hide message dialog
    function hideMessage() {
      messageDialog.classList.remove('show');
    }

    // Show preview window
    function showPreview(imageSrc) {
      previewImage.src = imageSrc;
      downloadLink.href = imageSrc;
      previewWindow.classList.add('show');
    }

    // Hide preview window
    function hidePreview() {
      previewWindow.classList.remove('show');
    }

    // Update character count
    function updateCharCount() {
      const text = messageEditor.innerText || '';
      charCount.textContent = `Characters: ${text.length}`;
    }

    // Apply formatting
    function applyFormatting() {
      document.execCommand('styleWithCSS', false, true);
      
      if (isBold) document.execCommand('bold', false, null);
      if (isItalic) document.execCommand('italic', false, null);
      if (isUnderline) document.execCommand('underline', false, null);
      
      messageEditor.style.fontSize = `${currentFontSize}px`;
      messageEditor.style.color = currentTextColor;
      textColorBtn.querySelector('.color-box').style.backgroundColor = currentTextColor;
      messageEditor.style.textAlign = currentAlign;
      
      boldBtn.classList.toggle('active', isBold);
      italicBtn.classList.toggle('active', isItalic);
      underlineBtn.classList.toggle('active', isUnderline);
      
      alignLeftBtn.classList.remove('active');
      alignCenterBtn.classList.remove('active');
      alignRightBtn.classList.remove('active');
      
      if (currentAlign === 'left') alignLeftBtn.classList.add('active');
      if (currentAlign === 'center') alignCenterBtn.classList.add('active');
      if (currentAlign === 'right') alignRightBtn.classList.add('active');
    }

    // Initialize
    function init() {
      // Try to load saved data
      const hasSavedData = loadFromLocalStorage();
      
      if (!hasSavedData) {
        // Set default values if no saved data
        applyFormatting();
        cardBody.style.setProperty('--card-color', cardColorInput.value);
        messageEditor.style.fontFamily = fontFamilySelect.value;
      }
      
      updateCharCount();
      
      // Show welcome message if first time
      if (!hasSavedData) {
        setTimeout(() => {
          showMessage('Your work is automatically saved locally. Only you can see it.', 'info');
        }, 500);
      }
    }

    // ========== EVENT LISTENERS ==========

    // Auto-save on content changes
    messageEditor.addEventListener('input', () => {
      updateCharCount();
      triggerAutoSave();
    });
    
    recipientInput.addEventListener('input', triggerAutoSave);
    
    // Formatting button events
    boldBtn.addEventListener('click', () => {
      isBold = !isBold;
      applyFormatting();
      triggerAutoSave();
    });
    
    italicBtn.addEventListener('click', () => {
      isItalic = !isItalic;
      applyFormatting();
      triggerAutoSave();
    });
    
    underlineBtn.addEventListener('click', () => {
      isUnderline = !isUnderline;
      applyFormatting();
      triggerAutoSave();
    });
    
    alignLeftBtn.addEventListener('click', () => {
      currentAlign = 'left';
      applyFormatting();
      triggerAutoSave();
    });
    
    alignCenterBtn.addEventListener('click', () => {
      currentAlign = 'center';
      applyFormatting();
      triggerAutoSave();
    });
    
    alignRightBtn.addEventListener('click', () => {
      currentAlign = 'right';
      applyFormatting();
      triggerAutoSave();
    });
    
    textColorBtn.addEventListener('click', () => {
      textColorInput.click();
    });
    
    textColorInput.addEventListener('input', () => {
      currentTextColor = textColorInput.value;
      applyFormatting();
      triggerAutoSave();
    });
    
    increaseSizeBtn.addEventListener('click', () => {
      currentFontSize = Math.min(36, currentFontSize + 2);
      applyFormatting();
      triggerAutoSave();
    });
    
    decreaseSizeBtn.addEventListener('click', () => {
      currentFontSize = Math.max(12, currentFontSize - 2);
      applyFormatting();
      triggerAutoSave();
    });
    
    clearFormatBtn.addEventListener('click', () => {
      isBold = false;
      isItalic = false;
      isUnderline = false;
      currentAlign = 'left';
      currentFontSize = 18;
      currentTextColor = '#ffffff';
      textColorInput.value = '#ffffff';
      applyFormatting();
      messageEditor.style.fontFamily = fontFamilySelect.value;
      triggerAutoSave();
    });

    // Card color change
    cardColorInput.addEventListener('input', () => {
      cardBody.style.setProperty('--card-color', cardColorInput.value);
      triggerAutoSave();
    });

    // Font family change
    fontFamilySelect.addEventListener('change', () => {
      messageEditor.style.fontFamily = fontFamilySelect.value;
      triggerAutoSave();
    });

    // Save as image
    function saveAsImage() {
      showMessage('Saving image... Please wait.', 'info');
      
      const formatWindow = document.querySelector('.format-window');
      const controlsWindow = document.querySelector('.controls-window');
      const originalFormatDisplay = formatWindow.style.display;
      const originalControlsDisplay = controlsWindow.style.display;
      
      formatWindow.style.display = 'none';
      controlsWindow.style.display = 'none';
      
      html2canvas(card, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        logging: false
      }).then(canvas => {
        formatWindow.style.display = originalFormatDisplay;
        controlsWindow.style.display = originalControlsDisplay;
        
        hideMessage();
        showPreview(canvas.toDataURL('image/png'));
        
        // Save to localStorage as well
        saveToLocalStorage();
      }).catch(error => {
        console.error('Error generating image:', error);
        formatWindow.style.display = originalFormatDisplay;
        controlsWindow.style.display = originalControlsDisplay;
        showMessage('Error saving image. Please try again.', 'error');
      });
    }

    // Burn effect
    function applyBurnEffect() {
      showMessage('Burning message...', 'info');
      card.classList.add('burning');
      
      setTimeout(() => {
        card.classList.remove('burning');
        messageEditor.innerHTML = '';
        recipientInput.value = 'whatever';
        cardColorInput.value = '#7b8464';
        cardBody.style.setProperty('--card-color', '#7b8464');
        fontFamilySelect.value = "'Comic Sans MS', cursive";
        messageEditor.style.fontFamily = fontFamilySelect.value;
        
        clearFormatBtn.click();
        
        // Clear localStorage when burning
        clearLocalStorage();
        
        showMessage('Message burned and storage cleared!', 'success');
        updateCharCount();
      }, 3000);
    }

    // Reset editor
    function resetEditor() {
      messageEditor.innerHTML = 'I still use your name to test out pens<br><br>Sometimes I write letters I\'ll never send,<br>Just to feel the weight of the words in my hand.';
      recipientInput.value = 'you';
      cardColorInput.value = '#7b8464';
      cardBody.style.setProperty('--card-color', '#7b8464');
      fontFamilySelect.value = "'Comic Sans MS', cursive";
      messageEditor.style.fontFamily = fontFamilySelect.value;
      
      clearFormatBtn.click();
      
      // Save reset state
      saveToLocalStorage();
      
      showMessage('Editor reset to initial state.', 'success');
      updateCharCount();
    }

    // Manual save button (optional)
    function manualSave() {
      saveToLocalStorage();
      showMessage('Manually saved!', 'success');
    }

    // Button event listeners
    sendBtn.addEventListener('click', saveAsImage);
    burnBtn.addEventListener('click', applyBurnEffect);
    saveImageBtn.addEventListener('click', saveAsImage);
    burnEffectBtn.addEventListener('click', applyBurnEffect);
    resetBtn.addEventListener('click', resetEditor);

    // Dialog event listeners
    closeDialogBtn.addEventListener('click', hideMessage);
    dialogOkBtn.addEventListener('click', hideMessage);
    closePreviewBtn.addEventListener('click', hidePreview);
    closePreviewBtn2.addEventListener('click', hidePreview);

    // Save before page unload
    window.addEventListener('beforeunload', () => {
      saveToLocalStorage();
    });

    // Initialize on load
    window.addEventListener('DOMContentLoaded', init);
    
    // Also auto-save periodically (every 30 seconds)
    setInterval(() => {
      if (messageEditor.innerHTML || recipientInput.value !== 'whatever') {
        saveToLocalStorage();
      }
    }, 30000);
  </script>
</body>
</html>